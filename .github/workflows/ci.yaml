name: Full CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

######################################################################
# ğŸ§© Backend Job â€“ Spring Boot service (services/backend)
######################################################################
jobs:
  backend:
    name: "Build & Test Backend (Spring Boot)"
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: â˜• Set up Temurin JDK 17 & Maven cache
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      # ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¨Ù‚Ø§ÙŠØ§ Ø¹Ù…ÙŠÙ„ Dart Ù‚Ø¯ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (Ø§Ø­ØªÙŠØ§Ø·)
      - name: ğŸ§¹ Remove obsolete generated clients
        run: rm -rf apps/*/lib/generated

      # ÙŠÙˆÙ„Ù‘Ø¯ stubs Ù„Ù„Ù€ Backend + Dart client ÙÙŠ packages/template_api
      - name: ğŸ”§ Generate OpenAPI stubs & Dart client
        run: ./scripts/generate.sh

      - name: ğŸ—ï¸ Build & unitâ€‘test backend
        working-directory: services/backend
        run: ./mvnw -q clean verify

      - name: ğŸ“Š Jacoco coverage report
        if: always()
        working-directory: services/backend
        run: ./mvnw jacoco:report

######################################################################
# ğŸ¦ Flutter Job â€“ UI + Dart client
######################################################################
  flutter:
    name: "Build & Test Flutter"
    needs: backend   # ÙŠÙ†ØªØ¸Ø± Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€ backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - apps/guest_app
          - apps/admin_app
          - apps/cleaner_app

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ¦ Set up Flutter SDK (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: â™»ï¸ Restore pub cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      # ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù‚Ø¯ÙŠÙ… Ø«Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø§ØªØ³Ø§Ù‚
      - name: ğŸ”§ Ensure Dart client is upâ€‘toâ€‘date
        run: ./scripts/generate.sh

      # â”€â”€â”€ Build template_api package â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install template_api dependencies
        working-directory: packages/template_api
        run: flutter pub get

      - name: âš™ï¸ Generate built_value *.g.dart (template_api)
        working-directory: packages/template_api
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # â”€â”€â”€ Build Flutter app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ matrix.app }}
        run: flutter pub get

      - name: ğŸ” Static analysis (fatalâ€‘warnings)
        working-directory: ${{ matrix.app }}
        run: flutter analyze --fatal-warnings

      - name: âœ… Run Flutter tests (with coverage)
        working-directory: ${{ matrix.app }}
        run: flutter test --coverage

      - name: ğŸ“Š Generate HTML coverage (lcov)
        if: success()
        working-directory: ${{ matrix.app }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html
######################################################################
# ğŸ Python Job â€“ unit tests
######################################################################
  python-tests:
    name: "Run Python Tests"
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: âœ… Run Pytest
        run: pytest -q


######################################################################
# âœ¨ Matrix spot for future services â€“ ready to extend
######################################################################
#  e.g. add another backend here with:
#  matrix:
#    include:
#      - path: services/user-service
